<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/main.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/dramamine/leftovers-again.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ai.js~AI.html">AI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/battle.js~Battle.html">Battle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/connection.js~Connection.html">Connection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decisions.js~Decision.html">Decision</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decisions.js~MOVE.html">MOVE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/decisions.js~SWITCH.html">SWITCH</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/listener.js~Listener.html">Listener</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/log.js~Log.html">Log</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/monkey.js~Monkey.html">Monkey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/report.js~Report.html">Report</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/team.js~Team.html">Team</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-botFinder">botFinder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-start">start</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">game</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/game/typechart.js~Typechart.html">Typechart</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">interfaces</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/interfaces/cli.js~Interactive.html">Interactive</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/interfaces/params.js~Challenger.html">Challenger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">model</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/battlestore.js~BattleStore.html">BattleStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/challenges.js~Challenger.html">Challenger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/lobby.js~Lobby.html">Lobby</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/pokemon.js~Pokemon.html">Pokemon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/side.js~Side.html">Side</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/timer.js~Timer.html">Timer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-MoveData">MoveData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PokemonData">PokemonData</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/main.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">require(&apos;module-alias&apos;).addAlias(&apos;@la&apos;, __dirname);
const socket = require(&apos;./socket&apos;);
const monkey = require(&apos;./monkey&apos;);
const listener = require(&apos;./listener&apos;);
const defaults = require(&apos;./defaults&apos;);
const BotManager = require(&apos;./botmanager&apos;);
const BattleManager = require(&apos;./battlemanager&apos;);
const Spawner = require(&apos;./spawner&apos;);
const Interactive = require(&apos;./interfaces/cli&apos;);
const Challenger = require(&apos;./model/challenges&apos;);
const Lobby = require(&apos;./model/lobby&apos;);
const Log = require(&apos;./log&apos;);
const { MOVE, SWITCH } = require(&apos;./decisions&apos;);

let challenger;
let myconnection;
let lobby;

/**
 * This is kind of crappy, but this helps out with testing. When you&apos;re using
 * nodemon for &apos;livereload&apos;-ish functionality, you want to close your connection
 * before you do anything.
 *
 * @param  {Object} options Options object with these properties:
 *                          cleanup: run cleanup task
 *                          exit: exit the process after you&apos;re done
 * @param  {Object} err     The JS error message if there is one.
 *
 */
function exitHandler(options, err) {
  if (err) console.error(err.stack);
  if (challenger) challenger.cancelOutstandingChallenges();
  Spawner.kill();
  setTimeout(() =&gt; {
    if (myconnection) myconnection.close();
    if (options.exit) process.exit();
  }, 100);
}

/**
 * Show the help menu.
 */
function displayHelp() {
  console.log(`
Leftovers Again: interface for Pokemon Showdown bots

-bot [path]:     path to your bot class. REQUIRED.
-config [path]: specify a config file (ex. &quot;./package.json&quot;)
-format:        specify a format for challenges (ex. &quot;randombattle&quot;, &quot;ou&quot;)
-h, --help:      show this menu
-ajax:           don&apos;t use this
-monkey:         listen to userscripts instead of connecting to a server
-matches [n]:  exit after n matches. default 0 means &quot;don&apos;t exit&quot;
-nickname [name]  login name (for Smogon official login server)
-password [pw]    account password (required for registered nicknames)
-loglevel [1-6]: level of severity of logs to show. higher levels are more
                 verbose. default 3. all server messages shown at 6.
-opponent [path]: Spawn a specific opponent via a child process.
-opponents [paths]: Spawn multiple opponents, ex. randumb,stabby,../anotherbot
-production:    Connect to Cyberdyne
-results [path]  Specify a path for results.csv (W-L records for your bots)
-scrappy:       Have your bot pick fights with anyone who&apos;s in the lobby or
                who joins the lobby.
-server [path]: Connect to a specific server.
-timeout [ms]:  Time out the bot after x milliseconds. (default 0, disabled)
`);
}

/**
 * argv: i.e., process.argv
 */
const start = (metadata, Bot) =&gt; {
  const info = new BotManager(metadata, Bot);

  // process cmdline args
  const args = require(&apos;minimist&apos;)(process.argv.slice(2));

  let config = {};
  if (args.config) {
    config = require(args.config);
  }

  if (args.help || args.h) {
    displayHelp();
    process.exit();
  }

  if (args.opponent) {
    Spawner.spawn(args.opponent);
    args.scrappy = true;
  } else if (args.opponents) {
    args.opponents.split(&apos;,&apos;).forEach((opponent) =&gt; {
      Spawner.spawn(opponent);
    });
    args.scrappy = true;
  }

  // for everything else, check args, then bot info, then defaults.
  // lots of these, you wouldn&apos;t really want them in bot info, but eh, whatever.
  const params = [&apos;scrappy&apos;, &apos;format&apos;, &apos;nickname&apos;, &apos;password&apos;, &apos;server&apos;, &apos;matches&apos;,
    &apos;production&apos;, &apos;prodServer&apos;, &apos;loglevel&apos;, &apos;results&apos;, &apos;test&apos;, &apos;timeout&apos;];
  params.forEach((param) =&gt; {
    args[param] = args[param] || metadata[param] || config[param] || defaults[param];
  });

  // use prodServer if user had --production flag
  if (args.production) {
    if (args.scrappy) {
      Log.error(&apos;Come on! You can\&apos;t challenge EVERYONE on the PRODUCTION server.&apos;);
      process.exit();
    }
    args.server = args.prodServer;
  }

  // connect to greasemonkey, or use websockets like a normal person
  if (args.monkey) {
    myconnection = monkey;
  } else {
    myconnection = socket;
  }

  if (args.loglevel) {
    Log.setLogLevel(args.loglevel);
  }

  lobby = new Lobby();
  // create some necessary classes
  challenger = new Challenger(myconnection, info, args);

  // battlemanager is going to create new battles as we learn about them.
  // for each one, it creates a new instance of a battle and of our AI class.
  // listener needs to know about the BattleManager to properly relay battle
  // messages to the right battle instance.
  const battlemanager = new BattleManager(info.BotClass, args.timeout);
  listener.use(battlemanager);

  // connect to a server, or create one and start listening.
  myconnection.connect(args);

  let interactive; // eslint-disable-line
  if (args.interactive || args.i) {
    interactive = new Interactive({
      challenger,
      lobby
    });
  }


  // do something when app is closing
  process.on(&apos;exit&apos;, exitHandler.bind(null, {
    cleanup: true
  }));

  // catches ctrl+c event
  process.on(&apos;SIGINT&apos;, exitHandler.bind(null, {
    exit: true
  }));

  // catches uncaught exceptions
  process.on(&apos;uncaughtException&apos;, exitHandler.bind(null, {
    exit: true
  }));
};

module.exports = {
  start,
  MOVE,
  SWITCH
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
